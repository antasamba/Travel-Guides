<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Guide</title>

  <!-- Font Awesome för hjärtikoner -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#111;
      --panel2:#1a1a1a;
      --text:#fff;
      --muted:#cfcfe0;
      --neon:#b026ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    header{
      position:relative;height:48vh;min-height:320px;
      display:flex;align-items:center;justify-content:center;
      background:#111 center/cover no-repeat;
      isolation:isolate;
    }
    header::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.55)}
    h1{
      position:relative;z-index:1;margin:0;font-size:54px;text-transform:lowercase;
      text-shadow:0 0 18px var(--neon),0 0 36px var(--neon)
    }

    .search{
      position:relative;z-index:2;width:100%;max-width:100%;
      margin:-32px auto 36px;padding:14px;
      background:var(--panel2);border-radius:14px;box-shadow:0 0 28px rgba(176,38,255,.25);
      display:flex;gap:10px;align-items:center;justify-content:center;
      flex-wrap:nowrap;
    }
    input,select,button{border:none;border-radius:10px;padding:12px 14px;font-size:16px;outline:none}
    input,select{flex:1;color:var(--text);background:var(--panel);min-width:0}
    option{color:#000}
    button{background:var(--neon);color:#fff;font-weight:700;cursor:pointer;transition:.2s ease;min-width:72px;white-space:nowrap}
    button:hover{filter:brightness(1.1)}

    /* Globalt hjärta */
    .top-heart{
      flex:0 0 auto;
      text-decoration:none;display:inline-flex;align-items:center;justify-content:center
    }
    .top-heart i{
      font-size:22px;color:transparent;-webkit-text-stroke:2px var(--neon);text-shadow:0 0 8px var(--neon)
    }
    .top-heart i.active{filter:brightness(1.1);text-shadow:0 0 14px var(--neon),0 0 30px var(--neon)}

    /* Resultatgrid: alltid 3 kolumner */
    .results{
      max-width:1200px;margin:0 auto 60px;padding:0 20px;
      display:grid;gap:20px;
      grid-template-columns: repeat(3, 1fr);
    }
    .card{
      background:var(--panel);border-radius:16px;overflow:hidden;position:relative;
      box-shadow:0 0 14px rgba(176,38,255,.18);transition:transform .18s,box-shadow .18s
    }
    .card:hover{transform:translateY(-3px);box-shadow:0 0 24px rgba(176,38,255,.32)}
    .media-wrap{position:relative}
    .card img{width:100%;height:190px;object-fit:cover;background:#222;display:block}

    /* Hjärta på kortet */
    .fav-heart{
      position:absolute;top:10px;right:10px;z-index:3;cursor:pointer;
      font-size:22px;line-height:1;
      color:transparent;-webkit-text-stroke:2px var(--neon);text-shadow:0 0 8px var(--neon);
      background:rgba(0,0,0,.25);border-radius:999px;padding:6px
    }
    .fav-heart.active{
      -webkit-text-stroke:2px var(--neon);color:transparent;
      text-shadow:0 0 14px var(--neon),0 0 30px var(--neon)
    }

    .card-body{padding:16px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0;font-size:18px}
    .card p{margin:0;color:var(--muted);font-size:14px}
    .card a{color:var(--neon);text-decoration:none;font-weight:700}
    .empty{max-width:980px;margin:8px auto 24px;padding:0 20px;color:#bbb}

    html,body{width:100%;overflow-x:hidden}
  </style>
</head>
<body>
  <header id="hero">
    <h1 id="cityTitle">travel guide</h1>
  </header>

  <div class="search">
    <input id="city" placeholder="Skriv stad, t.ex. Tokyo">
    <select id="interest">
      <option value="tourism.sights">Sevärdheter</option>
      <option value="entertainment.museum">Museum</option>
      <option value="catering.cafe">Caféer</option>
      <option value="catering.restaurant">Restauranger</option>
      <option value="leisure.park">Parker</option>
      <option value="commercial.shopping_mall">Shopping</option>
      <option value="entertainment.theatre">Teater</option>
      <option value="accommodation.hotel">Hotell</option>
    </select>
    <button onclick="searchPlaces()">Sök</button>
    <a class="top-heart" href="favorites.html" title="Favoriter">
      <i id="topHeart" class="fa-regular fa-heart"></i>
    </a>
  </div>

  <div id="msg" class="empty"></div>
  <div id="results" class="results"></div>

  <script>
    const GEOAPIFY_KEY = "b88860a7587b40888eb04b41c1133d49";
    const PIXABAY_KEY = "42339997-3d0b7f62db6b10b33e3ff48d8";

    let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
    function persistFavs(){ localStorage.setItem("favorites", JSON.stringify(favorites)); updateTopHeart(); }
    function favKey(p){ return `${p.name}|${p.address||""}`; }
    function isFav(p){ return favorites.some(x => favKey(x)===favKey(p)); }
    function toggleFav(p, heartEl){
      if(isFav(p)){ favorites = favorites.filter(x => favKey(x)!==favKey(p)); heartEl.classList.remove('active'); }
      else{ favorites.push(p); heartEl.classList.add('active'); }
      persistFavs();
    }
    function updateTopHeart(){
      const th = document.getElementById('topHeart');
      if((favorites||[]).length>0){ th.classList.add('active'); }
      else{ th.classList.remove('active'); }
    }
    updateTopHeart();

    async function wikidataImage(wdId){
      try{
        const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&format=json&origin=*&ids=${encodeURIComponent(wdId)}&props=claims`;
        const data = await fetch(url).then(r=>r.json());
        const entity = data.entities && data.entities[wdId];
        const p18 = entity?.claims?.P18?.[0];
        const file = p18?.mainsnak?.datavalue?.value;
        if(file) return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(file)}?width=1200`;
      }catch(e){}
      return null;
    }
    async function wikiThumb(query){
      const langs = ["sv","en","ja","no","nn","da","de","fr","es","it"];
      for(const lang of langs){
        try{
          const url = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&prop=pageimages|info&inprop=url&piprop=thumbnail&pithumbsize=1200&generator=search&gsrsearch=${encodeURIComponent(query)}&gsrlimit=1`;
          const data = await fetch(url).then(r=>r.json());
          if(data.query?.pages){
            const k = Object.keys(data.query.pages)[0];
            const page = data.query.pages[k];
            if(page?.thumbnail?.source) return page.thumbnail.source;
          }
        }catch(e){}
      }
      return null;
    }
    async function bestPlaceImage(props, city){
      const wd = props?.datasource?.raw?.wikidata || props?.wikidata;
      if(wd){
        const img = await wikidataImage(wd);
        if(img) return img;
      }
      const byName = await wikiThumb(`${props.name||""} ${city}`);
      if(byName) return byName;
      return "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Night_sky_stars.jpg/1280px-Night_sky_stars.jpg";
    }
    async function heroImage(city){
      const w = await wikiThumb(city);
      if(w) return w;
      try{
        const u = `https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(city)}&image_type=photo&orientation=horizontal&per_page=3`;
        const d = await fetch(u).then(r=>r.json());
        if(d.hits?.length) return d.hits[0].webformatURL;
      }catch(e){}
      return null;
    }

    const msg = document.getElementById('msg');
    const resultsDiv = document.getElementById('results');
    const cityTitle = document.getElementById('cityTitle');
    const hero = document.getElementById('hero');

    async function searchPlaces(){
      const city = document.getElementById('city').value.trim();
      const category = document.getElementById('interest').value;
      if(!city){ msg.textContent="Fyll i en stad."; return; }
      msg.textContent="Söker…"; resultsDiv.innerHTML=""; cityTitle.textContent = city.toLowerCase();

      (async()=>{ const hi = await heroImage(city); if(hi) hero.style.backgroundImage = `url('${hi}')`; })();

      try{
        const geoURL = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(city)}&apiKey=${GEOAPIFY_KEY}`;
        const gj = await fetch(geoURL).then(r=>r.json());
        if(!gj.features?.length){ msg.textContent="Kunde inte hitta staden."; return; }
        const { lon, lat } = gj.features[0].properties;

        const placesURL = `https://api.geoapify.com/v2/places?categories=${encodeURIComponent(category)}&filter=circle:${lon},${lat},6000&limit=12&apiKey=${GEOAPIFY_KEY}`;
        const pj = await fetch(placesURL).then(r=>r.json());
        if(!pj.features?.length){ msg.textContent="Inga resultat hittades."; return; }

        msg.textContent="";
        resultsDiv.innerHTML="";

        for(const f of pj.features){
          const p = f.properties||{};
          const name = p.name || "Okänd plats";
          const address = p.address_line1 || p.address_line2 || "";
          const link = p.website || (p.lon && p.lat ? `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}` : "#");

          const img = await bestPlaceImage(p, city);

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="media-wrap">
              <img src="${img}" alt="${name}">
              <i class="fa-regular fa-heart fav-heart" title="Favorit"></i>
            </div>
            <div class="card-body">
              <h3>${name}</h3>
              <p>${address}</p>
              <a href="${link}" target="_blank" rel="noopener">Läs mer →</a>
            </div>
          `;

          const heart = card.querySelector('.fav-heart');
          const favPayload = { name, address, url: link, image: img };
          if(isFav(favPayload)) heart.classList.add('active');
          heart.addEventListener('click', ()=> toggleFav(favPayload, heart));

          resultsDiv.appendChild(card);
        }
      }catch(err){
        console.error(err);
        msg.textContent="Fel vid hämtning av data.";
      }
    }
  </script>
</body>
</html>
